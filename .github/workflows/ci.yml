name: CI - Feature Branches

on:
  push:
    branches:
      - 'feature/**'

permissions:
  contents: read
  pull-requests: write

jobs:
  install:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        working-directory: ./app
        run: make install

  lint:
    runs-on: ubuntu-latest
    needs: install
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        working-directory: ./app
        run: make install

      - name: Run lint
        working-directory: ./app
        run: make lint

  cover:
    runs-on: ubuntu-latest
    needs: install
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        working-directory: ./app
        run: make install

      - name: Run coverage
        working-directory: ./app
        run: make cover

  build:
    runs-on: ubuntu-latest
    needs: install
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        working-directory: ./app
        run: make install

      - name: Build
        working-directory: ./app
        run: make build

  create-pr:
    runs-on: ubuntu-latest
    needs: [lint, cover, build]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create Pull Request
        run: |
          BRANCH_NAME=${GITHUB_REF#refs/heads/}
          TITLE="Merge ${BRANCH_NAME} into develop"
          BODY="Automated PR for feature branch ${BRANCH_NAME}"
          gh pr create --base develop --head ${BRANCH_NAME} --title "${TITLE}" --body "${BODY}" || echo "PR already exists or failed to create"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
